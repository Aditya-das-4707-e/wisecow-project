# Name of the GitHub Actions workflow (shows in Actions tab)
name: CI Build Image & Update Manifest

# When should this pipeline run?
on:
  push:
    branches: [ "main" ]   # Runs only when code is pushed to main branch

jobs:
  build-and-update:        # Job name (can be anything)
    runs-on: ubuntu-latest # GitHub provides an Ubuntu VM to run this job

    steps:
      # Step 1: Pull your GitHub repository code into the runner VM
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Capture the Git commit ID and store it as IMAGE_TAG
      # GITHUB_SHA is automatically provided by GitHub Actions
      - name: Set image tag from Git commit
        run: echo "IMAGE_TAG=${GITHUB_SHA}" >> $GITHUB_ENV

      # Step 3: Login to Docker Hub using secrets
      # This allows docker push to work
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}  # Your Docker Hub username
          password: ${{ secrets.DOCKER_PASSWORD }}  # Your Docker Hub password/token

      # Step 4: Build Docker image and push it to Docker Hub
      - name: Build & Push Docker image
        uses: docker/build-push-action@v4
        with:
          context: wisecow-k8s   # Directory where Dockerfile exists
          push: true             # Actually push the image (not just build)
          # Image name + tag (commit ID)
          tags: ${{ secrets.DOCKER_USERNAME }}/wisecow:${{ env.IMAGE_TAG }}

      # Step 5: Update Kubernetes deployment manifest
      # This replaces whatever image tag exists with the new commit ID
      - name: Update Kubernetes manifest image
        run: |
          sed -i "s|image: .*|image: ${{ secrets.DOCKER_USERNAME }}/wisecow:${IMAGE_TAG}|" wisecow-k8s/k8s/deployment.yaml

      # Step 6: Commit the updated Kubernetes manifest back to GitHub
      # This Git change is what Argo CD watches
      - name: Commit & push manifest update
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add wisecow-k8s/k8s/deployment.yaml
          git commit -m "Deploy wisecow image ${IMAGE_TAG}"
          git push
