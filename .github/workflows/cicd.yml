name: CI Build Image & Update Manifest

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-update:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository code into the runner
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Capture Git commit ID and store it as IMAGE_TAG
      - name: Set image tag from Git commit
        run: echo "IMAGE_TAG=${GITHUB_SHA}" >> $GITHUB_ENV

      # 3️⃣ Login to Docker Hub (required for push)
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4️⃣ Build Docker image and push it using commit SHA tag
      - name: Build & Push Docker image
        uses: docker/build-push-action@v4
        with:
          context: wisecow-k8s
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/wisecow:${{ env.IMAGE_TAG }}

      # 5️⃣ Find Kubernetes deployment file dynamically
      - name: Find Kubernetes deployment manifest
        run: |
          DEPLOY_FILE=$(find . -name "deployment.y*ml" | head -n 1)
          echo "DEPLOY_FILE=$DEPLOY_FILE" >> $GITHUB_ENV
          echo "Found deployment file at: $DEPLOY_FILE"

      # 6️⃣ Update image in Kubernetes manifest
      - name: Update Kubernetes manifest image
        run: |
          sed -i "s|image: .*|image: ${{ secrets.DOCKER_USERNAME }}/wisecow:${IMAGE_TAG}|" $DEPLOY_FILE

      # 7️⃣ Commit and push the updated manifest
      - name: Commit & push manifest update
        run: |
          git config user.name "Aditya-das-4707-e"
          git config user.email "adityadas99906@gmail.com"
          git add $DEPLOY_FILE
          git diff --cached --quiet || git commit -m "Deploy wisecow image ${IMAGE_TAG}"
          git push https://x-access-token:${{ secrets.WISECOW_TOKEN }}@github.com/${{ github.repository }} HEAD:main
